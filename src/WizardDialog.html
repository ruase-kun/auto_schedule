<!DOCTYPE html>
<html>
<head>
<base target="_top">
<style>
  * { box-sizing: border-box; margin: 0; padding: 0; }
  body {
    font-family: 'Segoe UI', 'Meiryo', sans-serif;
    font-size: 14px;
    color: #333;
    background: #fff;
    padding: 20px;
  }
  .step-indicator {
    text-align: center;
    color: #666;
    font-size: 13px;
    margin-bottom: 16px;
  }
  .step-title {
    font-size: 16px;
    font-weight: bold;
    margin-bottom: 8px;
  }
  .step-desc {
    color: #666;
    font-size: 13px;
    margin-bottom: 12px;
  }
  .step { display: none; }
  .step.active { display: block; }

  /* 部署選択 */
  .dept-list { list-style: none; }
  .dept-list li {
    padding: 10px 12px;
    border: 1px solid #ddd;
    border-radius: 4px;
    margin-bottom: 8px;
    cursor: pointer;
    transition: background 0.15s;
  }
  .dept-list li:hover { background: #f0f4ff; }
  .dept-list li.selected {
    background: #e3edff;
    border-color: #4285f4;
  }
  .dept-list li label {
    cursor: pointer;
    display: block;
  }
  .dept-list li input[type="radio"] { margin-right: 8px; }

  /* 日付選択 */
  .date-list { list-style: none; max-height: 280px; overflow-y: auto; }
  .date-list li {
    padding: 8px 12px;
    border: 1px solid #ddd;
    border-radius: 4px;
    margin-bottom: 6px;
    cursor: pointer;
    transition: background 0.15s;
  }
  .date-list li:hover { background: #f0f4ff; }
  .date-list li.selected {
    background: #e3edff;
    border-color: #4285f4;
  }
  .date-list li label { cursor: pointer; display: block; }
  .date-list li input[type="checkbox"] { margin-right: 8px; }
  .staff-count { color: #888; font-size: 13px; margin-left: 8px; }
  .select-actions { margin-bottom: 8px; }
  .select-actions a {
    color: #4285f4;
    cursor: pointer;
    font-size: 13px;
    margin-right: 12px;
    text-decoration: none;
  }
  .select-actions a:hover { text-decoration: underline; }

  /* 終日除外 (Step 2) */
  .staff-excl-list {
    list-style: none;
    max-height: 300px;
    overflow-y: auto;
    border: 1px solid #e0e0e0;
    border-radius: 4px;
  }
  .staff-excl-item {
    padding: 8px 12px;
    border-bottom: 1px solid #f0f0f0;
  }
  .staff-excl-item:last-child { border-bottom: none; }
  .staff-excl-item label {
    display: flex;
    align-items: center;
    cursor: pointer;
  }
  .staff-excl-item input[type="checkbox"] { margin-right: 8px; }
  .employment-badge {
    display: inline-block;
    padding: 2px 6px;
    border-radius: 3px;
    font-size: 11px;
    margin-left: 8px;
    background: #f0f0f0;
    color: #666;
  }
  .employment-badge.leader { background: #fff3e0; color: #e65100; }
  .employment-badge.subleader { background: #e8f5e9; color: #2e7d32; }
  .excl-actions { margin-bottom: 8px; }
  .excl-actions a {
    color: #4285f4;
    cursor: pointer;
    font-size: 13px;
    margin-right: 12px;
    text-decoration: none;
  }
  .excl-actions a:hover { text-decoration: underline; }
  .excl-count {
    font-size: 12px;
    color: #888;
    margin-top: 6px;
  }

  /* 時間帯除外 / 大会除外 (Steps 3, 4) */
  .excl-rows { margin-bottom: 8px; }
  .excl-row {
    display: flex;
    align-items: center;
    gap: 6px;
    margin-bottom: 6px;
    padding: 8px;
    background: #f8f9fa;
    border-radius: 4px;
    flex-wrap: wrap;
  }
  .excl-row select {
    padding: 4px 6px;
    border: 1px solid #ddd;
    border-radius: 3px;
    font-size: 13px;
  }
  .excl-row .remove-btn {
    background: none;
    border: none;
    color: #999;
    font-size: 18px;
    cursor: pointer;
    padding: 0 4px;
  }
  .excl-row .remove-btn:hover { color: #ea4335; }
  .range-error {
    color: #c5221f;
    font-size: 11px;
    width: 100%;
    margin-top: 2px;
  }
  .add-btn {
    background: none;
    border: 1px dashed #4285f4;
    color: #4285f4;
    padding: 6px 16px;
    border-radius: 4px;
    cursor: pointer;
    font-size: 13px;
  }
  .add-btn:hover { background: #f0f4ff; }

  /* 大会プリセット */
  .preset-area { margin-bottom: 12px; }
  .preset-label { font-size: 13px; color: #555; margin-bottom: 6px; }
  .preset-btns { display: flex; flex-wrap: wrap; gap: 6px; }
  .preset-btn {
    padding: 6px 14px;
    border: 1px solid #4285f4;
    border-radius: 4px;
    background: #e8f0fe;
    color: #1a73e8;
    font-size: 13px;
    cursor: pointer;
    transition: background 0.15s;
  }
  .preset-btn:hover { background: #d2e3fc; }

  /* 確認画面 */
  .confirm-section { margin-bottom: 10px; }
  .confirm-label { font-weight: bold; color: #555; font-size: 13px; }
  .confirm-value { margin-top: 2px; font-size: 13px; }

  /* 結果表示 */
  .result-item {
    padding: 6px 0;
    border-bottom: 1px solid #eee;
    font-size: 13px;
  }
  .result-success { color: #0d7d2c; }
  .result-summary {
    font-size: 15px;
    font-weight: bold;
    margin-bottom: 12px;
    color: #0d7d2c;
  }

  /* ボタン */
  .btn-row {
    margin-top: 20px;
    display: flex;
    justify-content: space-between;
  }
  .btn {
    padding: 8px 24px;
    border: none;
    border-radius: 4px;
    font-size: 14px;
    cursor: pointer;
    transition: background 0.15s;
  }
  .btn:disabled { opacity: 0.5; cursor: not-allowed; }
  .btn-primary { background: #4285f4; color: #fff; }
  .btn-primary:hover:not(:disabled) { background: #3367d6; }
  .btn-secondary { background: #f1f3f4; color: #333; }
  .btn-secondary:hover:not(:disabled) { background: #e0e0e0; }
  .btn-danger { background: #ea4335; color: #fff; }
  .btn-danger:hover:not(:disabled) { background: #c5221f; }

  /* スピナー */
  .spinner-area {
    text-align: center;
    padding: 30px 0;
    display: none;
  }
  .spinner-area.visible { display: block; }
  .spinner {
    display: inline-block;
    width: 32px;
    height: 32px;
    border: 3px solid #e0e0e0;
    border-top-color: #4285f4;
    border-radius: 50%;
    animation: spin 0.8s linear infinite;
  }
  @keyframes spin { to { transform: rotate(360deg); } }
  .spinner-text { margin-top: 10px; color: #666; }

  /* エラー */
  .error-msg {
    background: #fce8e6;
    color: #c5221f;
    padding: 10px 12px;
    border-radius: 4px;
    margin-top: 12px;
    display: none;
    font-size: 13px;
  }
  .error-msg.visible { display: block; }

  /* ローディング初期 */
  .loading-area {
    text-align: center;
    padding: 40px 0;
    color: #666;
  }
</style>
</head>
<body>

<div id="loadingArea" class="loading-area">
  <div class="spinner" style="margin: 0 auto;"></div>
  <div class="spinner-text">読み込み中...</div>
</div>

<div id="wizardContent" style="display:none;">
  <div class="step-indicator" id="stepIndicator"></div>

  <!-- Step 0: 部署選択 -->
  <div class="step active" id="step0">
    <div class="step-title">部署を選択してください</div>
    <ul class="dept-list" id="deptList"></ul>
    <div class="btn-row">
      <span></span>
      <button class="btn btn-primary" id="btnStep0Next" disabled onclick="goToStep(1)">次へ</button>
    </div>
  </div>

  <!-- Step 1: 日付選択 -->
  <div class="step" id="step1">
    <div class="step-title">日付を選択してください</div>
    <ul class="date-list" id="dateList"></ul>
    <div id="dateSpinner" class="spinner-area">
      <div class="spinner" style="margin: 0 auto;"></div>
      <div class="spinner-text">日付を読み込み中...</div>
    </div>
    <div class="btn-row">
      <button class="btn btn-secondary" onclick="goToStep(0)">戻る</button>
      <button class="btn btn-primary" id="btnStep1Next" disabled onclick="goToStep(2)">次へ</button>
    </div>
  </div>

  <!-- Step 2: 終日除外設定 -->
  <div class="step" id="step2">
    <div class="step-title">終日除外設定</div>
    <div class="step-desc">配置から終日除外するスタッフを選択してください。リーダー・サブリーダーは初期状態でONになっています。</div>
    <div id="exclSpinner" class="spinner-area">
      <div class="spinner" style="margin: 0 auto;"></div>
      <div class="spinner-text">スタッフ情報を読み込み中...</div>
    </div>
    <div id="allDayContent" style="display:none;">
      <div class="excl-actions">
        <a onclick="allDaySetAll(true)">全員ON</a>
        <a onclick="allDaySetAll(false)">全員OFF</a>
        <a onclick="allDaySetLeaders()">リーダーのみON</a>
      </div>
      <ul class="staff-excl-list" id="allDayList"></ul>
      <div class="excl-count" id="allDayCount"></div>
    </div>
    <div class="btn-row">
      <button class="btn btn-secondary" onclick="goToStep(1)">戻る</button>
      <button class="btn btn-primary" id="btnStep2Next" onclick="goToStep(3)">次へ</button>
    </div>
  </div>

  <!-- Step 3: 時間帯除外設定 -->
  <div class="step" id="step3">
    <div class="step-title">時間帯除外設定</div>
    <div class="step-desc">特定の時間帯に配置から除外するスタッフを設定してください。不要な場合はそのまま「次へ」を押してください。</div>
    <div class="excl-rows" id="timeRangeRows"></div>
    <button class="add-btn" onclick="addTimeRange()">+ 追加</button>
    <div class="btn-row">
      <button class="btn btn-secondary" onclick="goToStep(2)">戻る</button>
      <button class="btn btn-primary" onclick="goToStep(4)">次へ</button>
    </div>
  </div>

  <!-- Step 4: 大会除外設定 -->
  <div class="step" id="step4">
    <div class="step-title">大会除外設定</div>
    <div class="step-desc">大会運営者の除外設定を行ってください。プリセットから追加すると時間帯が自動入力されます。大会がない場合はそのまま「次へ」を押してください。</div>
    <div class="preset-area" id="tournamentPresets"></div>
    <div class="excl-rows" id="tournamentRows"></div>
    <button class="add-btn" onclick="addTournament()">+ 手動追加</button>
    <div class="btn-row">
      <button class="btn btn-secondary" onclick="goToStep(3)">戻る</button>
      <button class="btn btn-primary" onclick="goToStep(5)">次へ</button>
    </div>
  </div>

  <!-- Step 5: 確認＆生成 -->
  <div class="step" id="step5">
    <div class="step-title">確認</div>
    <div id="confirmArea">
      <div class="confirm-section">
        <div class="confirm-label">部署</div>
        <div class="confirm-value" id="confirmDept"></div>
      </div>
      <div class="confirm-section">
        <div class="confirm-label">日付</div>
        <div class="confirm-value" id="confirmDates"></div>
      </div>
      <div class="confirm-section">
        <div class="confirm-label">終日除外</div>
        <div class="confirm-value" id="confirmAllDay"></div>
      </div>
      <div class="confirm-section">
        <div class="confirm-label">時間帯除外</div>
        <div class="confirm-value" id="confirmTimeRanges"></div>
      </div>
      <div class="confirm-section">
        <div class="confirm-label">大会除外</div>
        <div class="confirm-value" id="confirmTournaments"></div>
      </div>
    </div>
    <div id="generateSpinner" class="spinner-area">
      <div class="spinner" style="margin: 0 auto;"></div>
      <div class="spinner-text">生成しています...</div>
    </div>
    <div id="resultArea" style="display:none;">
    </div>
    <div id="errorArea" class="error-msg"></div>
    <div class="btn-row" id="confirmButtons">
      <button class="btn btn-secondary" id="btnStep5Back" onclick="goToStep(4)">戻る</button>
      <button class="btn btn-primary" id="btnGenerate" onclick="onGenerate()">生成する</button>
    </div>
    <div class="btn-row" id="closeButtons" style="display:none;">
      <span></span>
      <button class="btn btn-primary" onclick="google.script.host.close()">閉じる</button>
    </div>
  </div>
</div>

<script>
  var TOTAL_STEPS = 6;

  var state = {
    departments: [],
    selectedDept: null,
    dates: [],
    selectedDates: [],
    // 除外設定
    staffForExclusion: [],
    timeOptions: [],
    allDayExclusions: {},
    timeRangeExclusions: [],
    tournamentExclusions: [],
    // 大会プリセット（サーバーから動的ロード）
    tournamentPresets: [],
    // キャッシュ制御
    lastLoadedDatesKey: null
  };

  // --- 初期化 ---
  google.script.run
    .withSuccessHandler(function(depts) {
      state.departments = depts;
      renderDeptList();
      document.getElementById('loadingArea').style.display = 'none';
      document.getElementById('wizardContent').style.display = 'block';
      updateStepIndicator(0);
    })
    .withFailureHandler(function(err) {
      document.getElementById('loadingArea').innerHTML =
        '<div style="color:#c5221f;">部署一覧の取得に失敗しました: ' + err.message + '</div>';
    })
    .uiWizard_loadDepartments();

  // --- ステップ制御 ---
  function updateStepIndicator(step) {
    document.getElementById('stepIndicator').textContent =
      'ステップ ' + (step + 1) + '/' + TOTAL_STEPS;
  }

  function goToStep(step) {
    var steps = document.querySelectorAll('.step');
    for (var i = 0; i < steps.length; i++) {
      steps[i].classList.remove('active');
    }
    document.getElementById('step' + step).classList.add('active');
    updateStepIndicator(step);

    if (step === 1) {
      loadDates();
    } else if (step === 2) {
      loadStaffForExclusion();
    } else if (step === 4) {
      renderTournamentPresets();
    } else if (step === 5) {
      renderConfirm();
    }
  }

  // --- Step 0: 部署選択 ---
  function renderDeptList() {
    var ul = document.getElementById('deptList');
    ul.innerHTML = '';
    for (var i = 0; i < state.departments.length; i++) {
      var dept = state.departments[i];
      var li = document.createElement('li');
      li.setAttribute('data-name', dept.name);
      var label = document.createElement('label');
      var radio = document.createElement('input');
      radio.type = 'radio';
      radio.name = 'dept';
      radio.value = dept.name;
      radio.onchange = (function(name, el) {
        return function() { selectDept(name, el); };
      })(dept.name, li);
      label.appendChild(radio);
      label.appendChild(document.createTextNode(dept.name));
      li.appendChild(label);
      ul.appendChild(li);
    }
  }

  function selectDept(name, liEl) {
    state.selectedDept = name;
    var items = document.querySelectorAll('.dept-list li');
    for (var i = 0; i < items.length; i++) {
      items[i].classList.remove('selected');
    }
    liEl.classList.add('selected');
    document.getElementById('btnStep0Next').disabled = false;
  }

  // --- Step 1: 日付選択 ---
  function loadDates() {
    var dateList = document.getElementById('dateList');
    dateList.innerHTML = '';
    document.getElementById('dateSpinner').classList.add('visible');
    document.getElementById('btnStep1Next').disabled = true;

    google.script.run
      .withSuccessHandler(function(dates) {
        state.dates = dates;
        state.selectedDates = [];
        document.getElementById('dateSpinner').classList.remove('visible');
        renderDateList();
      })
      .withFailureHandler(function(err) {
        document.getElementById('dateSpinner').classList.remove('visible');
        dateList.innerHTML =
          '<li style="color:#c5221f;">日付の取得に失敗しました: ' + err.message + '</li>';
      })
      .uiWizard_loadDates(state.selectedDept);
  }

  function renderDateList() {
    var ul = document.getElementById('dateList');
    ul.innerHTML = '';
    for (var i = 0; i < state.dates.length; i++) {
      var d = state.dates[i];
      var li = document.createElement('li');
      li.setAttribute('data-value', d.dateValue);
      var label = document.createElement('label');
      var radio = document.createElement('input');
      radio.type = 'radio';
      radio.name = 'dateSelect';
      radio.value = d.dateValue;
      radio.onchange = (function(val, el) {
        return function() { selectDate(val, el); };
      })(d.dateValue, li);
      label.appendChild(radio);
      label.appendChild(document.createTextNode(
        d.dateStr + ' (' + d.dayOfWeek + ')'));
      var span = document.createElement('span');
      span.className = 'staff-count';
      span.textContent = '出勤: ' + d.staffCount + '名';
      label.appendChild(span);
      li.appendChild(label);
      ul.appendChild(li);
    }
  }

  function selectDate(val, liEl) {
    state.selectedDates = [val];
    var items = document.querySelectorAll('.date-list li');
    for (var i = 0; i < items.length; i++) {
      items[i].classList.remove('selected');
    }
    liEl.classList.add('selected');
    document.getElementById('btnStep1Next').disabled = false;
  }

  // --- Step 2: 終日除外設定 ---
  function loadStaffForExclusion() {
    // 日付が変更されていなければキャッシュを使用
    var currentKey = state.selectedDates.join(',');
    if (state.lastLoadedDatesKey === currentKey) {
      return;
    }

    document.getElementById('allDayContent').style.display = 'none';
    document.getElementById('exclSpinner').classList.add('visible');
    document.getElementById('btnStep2Next').disabled = true;

    google.script.run
      .withSuccessHandler(function(data) {
        state.staffForExclusion = data.staffList;
        state.timeOptions = data.timeOptions;
        state.tournamentPresets = data.tournamentPresets || [];
        state.lastLoadedDatesKey = currentKey;

        // 既存のallDayExclusionsを保持しつつ、新しいスタッフを初期化
        var newExcl = {};
        for (var i = 0; i < data.staffList.length; i++) {
          var s = data.staffList[i];
          if (state.allDayExclusions.hasOwnProperty(s.name)) {
            newExcl[s.name] = state.allDayExclusions[s.name];
          } else {
            var isLeader = s.employment &&
              (s.employment.indexOf('リーダー') !== -1 ||
               s.employment.indexOf('サブリーダー') !== -1);
            newExcl[s.name] = isLeader;
          }
        }
        state.allDayExclusions = newExcl;

        document.getElementById('exclSpinner').classList.remove('visible');
        document.getElementById('allDayContent').style.display = 'block';
        document.getElementById('btnStep2Next').disabled = false;
        renderAllDayList();
      })
      .withFailureHandler(function(err) {
        document.getElementById('exclSpinner').classList.remove('visible');
        document.getElementById('allDayContent').style.display = 'block';
        document.getElementById('allDayContent').innerHTML =
          '<div style="color:#c5221f;">スタッフ情報の取得に失敗しました: ' + err.message + '</div>';
      })
      .uiWizard_loadStaffForExclusion({
        departmentName: state.selectedDept,
        dateValues: state.selectedDates
      });
  }

  function renderAllDayList() {
    var ul = document.getElementById('allDayList');
    ul.innerHTML = '';
    var onCount = 0;
    for (var i = 0; i < state.staffForExclusion.length; i++) {
      var s = state.staffForExclusion[i];
      var isOn = state.allDayExclusions[s.name] || false;
      if (isOn) onCount++;

      var li = document.createElement('li');
      li.className = 'staff-excl-item';
      var label = document.createElement('label');
      var cb = document.createElement('input');
      cb.type = 'checkbox';
      cb.checked = isOn;
      cb.onchange = (function(name) {
        return function() {
          state.allDayExclusions[name] = this.checked;
          updateAllDayCount();
        };
      })(s.name);
      label.appendChild(cb);
      label.appendChild(document.createTextNode(s.name));
      if (s.employment) {
        var badge = document.createElement('span');
        badge.className = 'employment-badge';
        if (s.employment.indexOf('サブリーダー') !== -1) {
          badge.className += ' subleader';
        } else if (s.employment.indexOf('リーダー') !== -1) {
          badge.className += ' leader';
        }
        badge.textContent = s.employment;
        label.appendChild(badge);
      }
      li.appendChild(label);
      ul.appendChild(li);
    }
    updateAllDayCount();
  }

  function updateAllDayCount() {
    var count = 0;
    for (var name in state.allDayExclusions) {
      if (state.allDayExclusions[name]) count++;
    }
    document.getElementById('allDayCount').textContent =
      count + '名を終日除外';
  }

  function allDaySetAll(value) {
    for (var i = 0; i < state.staffForExclusion.length; i++) {
      state.allDayExclusions[state.staffForExclusion[i].name] = value;
    }
    renderAllDayList();
  }

  function allDaySetLeaders() {
    for (var i = 0; i < state.staffForExclusion.length; i++) {
      var s = state.staffForExclusion[i];
      var isLeader = s.employment &&
        (s.employment.indexOf('リーダー') !== -1 ||
         s.employment.indexOf('サブリーダー') !== -1);
      state.allDayExclusions[s.name] = isLeader;
    }
    renderAllDayList();
  }

  // --- Step 3: 時間帯除外設定 ---
  function buildStaffOptions() {
    var html = '<option value="">-- スタッフ --</option>';
    for (var i = 0; i < state.staffForExclusion.length; i++) {
      var name = state.staffForExclusion[i].name;
      html += '<option value="' + escHtml(name) + '">' + escHtml(name) + '</option>';
    }
    return html;
  }

  function buildTimeOptions(staffName) {
    var html = '<option value="-1">--:--</option>';
    var staff = staffName ? getStaffByName(staffName) : null;
    for (var i = 0; i < state.timeOptions.length; i++) {
      var opt = state.timeOptions[i];
      // スタッフが選択されている場合、シフト時間内のみ表示
      if (staff && (opt.timeMin < staff.shiftStartMin || opt.timeMin > staff.shiftEndMin)) {
        continue;
      }
      html += '<option value="' + opt.timeMin + '">' + opt.timeStr + '</option>';
    }
    return html;
  }

  function getStaffByName(name) {
    for (var i = 0; i < state.staffForExclusion.length; i++) {
      if (state.staffForExclusion[i].name === name) return state.staffForExclusion[i];
    }
    return null;
  }

  function escHtml(str) {
    return String(str).replace(/&/g, '&amp;').replace(/</g, '&lt;')
      .replace(/>/g, '&gt;').replace(/"/g, '&quot;');
  }

  function addTimeRange() {
    state.timeRangeExclusions.push({ name: '', startMin: -1, endMin: -1 });
    renderTimeRanges();
  }

  function removeTimeRange(idx) {
    state.timeRangeExclusions.splice(idx, 1);
    renderTimeRanges();
  }

  function updateTimeRange(idx, field, value) {
    state.timeRangeExclusions[idx][field] = value;
    if (field === 'name') {
      // スタッフ変更時: 時刻プルダウンをシフト時間内に絞り直す
      rebuildTimeDropdowns('timeRangeRows', idx, state.timeRangeExclusions[idx], 'updateTimeRange');
    }
    validateExclRow(document.getElementById('timeRangeRows').children[idx]);
  }

  function rebuildTimeDropdowns(containerId, idx, entry, updateFn) {
    var rowEl = document.getElementById(containerId).children[idx];
    var selects = rowEl.querySelectorAll('select');
    var filteredOpts = buildTimeOptions(entry.name);
    selects[1].innerHTML = filteredOpts;
    selects[2].innerHTML = filteredOpts;
    // 選択値がフィルタ後に存在しなければリセット
    selects[1].value = entry.startMin;
    if (String(selects[1].value) !== String(entry.startMin)) {
      entry.startMin = -1;
      selects[1].value = -1;
    }
    selects[2].value = entry.endMin;
    if (String(selects[2].value) !== String(entry.endMin)) {
      entry.endMin = -1;
      selects[2].value = -1;
    }
  }

  function renderTimeRanges() {
    var container = document.getElementById('timeRangeRows');
    container.innerHTML = '';
    var staffOpts = buildStaffOptions();
    for (var i = 0; i < state.timeRangeExclusions.length; i++) {
      var tr = state.timeRangeExclusions[i];
      var timeOpts = buildTimeOptions(tr.name);
      var div = document.createElement('div');
      div.className = 'excl-row';
      div.innerHTML =
        '<select onchange="updateTimeRange(' + i + ',\'name\',this.value)">' + staffOpts + '</select>' +
        '<select onchange="updateTimeRange(' + i + ',\'startMin\',parseInt(this.value))">' + timeOpts + '</select>' +
        '<span style="color:#888;">～</span>' +
        '<select onchange="updateTimeRange(' + i + ',\'endMin\',parseInt(this.value))">' + timeOpts + '</select>' +
        '<button class="remove-btn" onclick="removeTimeRange(' + i + ')" title="削除">×</button>';
      var selects = div.querySelectorAll('select');
      selects[0].value = tr.name;
      selects[1].value = tr.startMin;
      selects[2].value = tr.endMin;
      container.appendChild(div);
      validateExclRow(div);
    }
  }

  // --- Step 4: 大会除外設定 ---

  function hasWeekendSelected() {
    for (var i = 0; i < state.selectedDates.length; i++) {
      var d = new Date(state.selectedDates[i] + 'T00:00:00');
      var day = d.getDay();
      if (day === 0 || day === 6) return true;
    }
    return false;
  }

  function renderTournamentPresets() {
    var container = document.getElementById('tournamentPresets');
    var presets = state.tournamentPresets;
    if (!presets || presets.length === 0) {
      container.innerHTML = '<div class="preset-label" style="color:#888;">プリセットが未設定です（コンフィグ設定から追加できます）</div>';
      return;
    }
    var isWeekend = hasWeekendSelected();
    var html = '<div class="preset-label">プリセットから追加:</div><div class="preset-btns">';
    for (var i = 0; i < presets.length; i++) {
      var p = presets[i];
      if (p.weekendOnly && !isWeekend) continue;
      html += '<button class="preset-btn" onclick="addTournamentFromPreset(' + i + ')">' +
        p.label + ' (' + minToStr(p.startMin) + '～' + minToStr(p.endMin) + ')</button>';
    }
    html += '</div>';
    container.innerHTML = html;
  }

  function addTournamentFromPreset(presetIdx) {
    var p = state.tournamentPresets[presetIdx];
    state.tournamentExclusions.push({ name: '', startMin: p.startMin, endMin: p.endMin });
    renderTournaments();
  }

  function addTournament() {
    state.tournamentExclusions.push({ name: '', startMin: -1, endMin: -1 });
    renderTournaments();
  }

  function removeTournament(idx) {
    state.tournamentExclusions.splice(idx, 1);
    renderTournaments();
  }

  function updateTournament(idx, field, value) {
    state.tournamentExclusions[idx][field] = value;
    if (field === 'name') {
      rebuildTimeDropdowns('tournamentRows', idx, state.tournamentExclusions[idx], 'updateTournament');
    }
    validateExclRow(document.getElementById('tournamentRows').children[idx]);
  }

  function renderTournaments() {
    var container = document.getElementById('tournamentRows');
    container.innerHTML = '';
    var staffOpts = buildStaffOptions();
    for (var i = 0; i < state.tournamentExclusions.length; i++) {
      var t = state.tournamentExclusions[i];
      var timeOpts = buildTimeOptions(t.name);
      var div = document.createElement('div');
      div.className = 'excl-row';
      div.innerHTML =
        '<select onchange="updateTournament(' + i + ',\'name\',this.value)">' + staffOpts + '</select>' +
        '<select onchange="updateTournament(' + i + ',\'startMin\',parseInt(this.value))">' + timeOpts + '</select>' +
        '<span style="color:#888;">～</span>' +
        '<select onchange="updateTournament(' + i + ',\'endMin\',parseInt(this.value))">' + timeOpts + '</select>' +
        '<button class="remove-btn" onclick="removeTournament(' + i + ')" title="削除">×</button>';
      var selects = div.querySelectorAll('select');
      selects[0].value = t.name;
      selects[1].value = t.startMin;
      selects[2].value = t.endMin;
      container.appendChild(div);
      validateExclRow(div);
    }
  }

  // --- 共通バリデーション ---
  function validateExclRow(rowEl) {
    var selects = rowEl.querySelectorAll('select');
    var start = parseInt(selects[1].value);
    var end = parseInt(selects[2].value);
    var existing = rowEl.querySelector('.range-error');
    if (start >= 0 && end >= 0 && start >= end) {
      if (!existing) {
        var span = document.createElement('div');
        span.className = 'range-error';
        span.textContent = '開始時刻は終了時刻より前にしてください';
        rowEl.appendChild(span);
      }
    } else if (existing) {
      existing.remove();
    }
  }

  // --- 有効なエントリのみ抽出 ---
  function getValidTimeRanges() {
    var valid = [];
    for (var i = 0; i < state.timeRangeExclusions.length; i++) {
      var tr = state.timeRangeExclusions[i];
      if (tr.name && tr.startMin >= 0 && tr.endMin > tr.startMin) {
        valid.push({ name: tr.name, startMin: tr.startMin, endMin: tr.endMin });
      }
    }
    return valid;
  }

  function getValidTournaments() {
    var valid = [];
    for (var i = 0; i < state.tournamentExclusions.length; i++) {
      var t = state.tournamentExclusions[i];
      if (t.name && t.startMin >= 0 && t.endMin > t.startMin) {
        valid.push({ name: t.name, startMin: t.startMin, endMin: t.endMin });
      }
    }
    return valid;
  }

  function getAllDayNames() {
    var names = [];
    for (var name in state.allDayExclusions) {
      if (state.allDayExclusions[name]) names.push(name);
    }
    return names;
  }

  // --- ヘルパー ---
  function minToStr(min) {
    var h = Math.floor(min / 60);
    var m = min % 60;
    return h + ':' + (m < 10 ? '0' + m : '' + m);
  }

  // --- Step 5: 確認＆生成 ---
  function renderConfirm() {
    document.getElementById('confirmDept').textContent = state.selectedDept;

    // 日付
    var dateTexts = [];
    for (var i = 0; i < state.selectedDates.length; i++) {
      var val = state.selectedDates[i];
      for (var j = 0; j < state.dates.length; j++) {
        if (state.dates[j].dateValue === val) {
          dateTexts.push(state.dates[j].dateStr + '(' + state.dates[j].dayOfWeek + ')');
          break;
        }
      }
    }
    document.getElementById('confirmDates').textContent =
      dateTexts.join(', ') + ' (' + dateTexts.length + '件)';

    // 終日除外
    var allDayNames = getAllDayNames();
    document.getElementById('confirmAllDay').textContent =
      allDayNames.length > 0
        ? allDayNames.join(', ') + ' (' + allDayNames.length + '名)'
        : 'なし';

    // 時間帯除外
    var validTR = getValidTimeRanges();
    if (validTR.length > 0) {
      var trTexts = [];
      for (var t = 0; t < validTR.length; t++) {
        trTexts.push(validTR[t].name + ' ' + minToStr(validTR[t].startMin) + '-' + minToStr(validTR[t].endMin));
      }
      document.getElementById('confirmTimeRanges').textContent =
        trTexts.join(', ') + ' (' + validTR.length + '件)';
    } else {
      document.getElementById('confirmTimeRanges').textContent = 'なし';
    }

    // 大会除外
    var validTT = getValidTournaments();
    if (validTT.length > 0) {
      var ttTexts = [];
      for (var u = 0; u < validTT.length; u++) {
        ttTexts.push(validTT[u].name + ' ' + minToStr(validTT[u].startMin) + '-' + minToStr(validTT[u].endMin));
      }
      document.getElementById('confirmTournaments').textContent =
        ttTexts.join(', ') + ' (' + validTT.length + '件)';
    } else {
      document.getElementById('confirmTournaments').textContent = 'なし';
    }

    // UIリセット
    document.getElementById('confirmArea').style.display = 'block';
    document.getElementById('generateSpinner').classList.remove('visible');
    document.getElementById('resultArea').style.display = 'none';
    document.getElementById('errorArea').classList.remove('visible');
    document.getElementById('confirmButtons').style.display = 'flex';
    document.getElementById('closeButtons').style.display = 'none';
  }

  function onGenerate() {
    document.getElementById('btnGenerate').disabled = true;
    document.getElementById('btnStep5Back').disabled = true;
    document.getElementById('generateSpinner').classList.add('visible');
    document.getElementById('errorArea').classList.remove('visible');

    var params = {
      departmentName: state.selectedDept,
      dateValues: state.selectedDates,
      exclusions: {
        allDay: getAllDayNames(),
        timeRanges: getValidTimeRanges(),
        tournaments: getValidTournaments()
      }
    };

    google.script.run
      .withSuccessHandler(function(result) {
        document.getElementById('generateSpinner').classList.remove('visible');
        showResult(result);
      })
      .withFailureHandler(function(err) {
        document.getElementById('generateSpinner').classList.remove('visible');
        document.getElementById('btnGenerate').disabled = false;
        document.getElementById('btnStep5Back').disabled = false;
        var errorArea = document.getElementById('errorArea');
        errorArea.textContent = '生成に失敗しました: ' + err.message;
        errorArea.classList.add('visible');
      })
      .uiWizard_generate(params);
  }

  function showResult(result) {
    document.getElementById('confirmButtons').style.display = 'none';
    document.getElementById('closeButtons').style.display = 'flex';

    var area = document.getElementById('resultArea');
    area.style.display = 'block';

    var html = '<div class="result-summary">' +
      result.results.length + '件の配置を生成しました</div>';
    for (var i = 0; i < result.results.length; i++) {
      var r = result.results[i];
      html += '<div class="result-item">' +
        r.dateSheet + ': ' + r.placementCount + '配置 / ' +
        r.staffCount + '名</div>';
      if (r.diag) {
        html += '<div style="background:#fff3e0;padding:10px;margin:8px 0;border-radius:4px;font-size:12px;white-space:pre-wrap;">';
        html += '<b>診断情報（0配置）</b>\n';
        html += 'プリセット数: ' + r.diag.presetCount + '\n';
        html += 'プリセット持ち場: ' + JSON.stringify(r.diag.presetPosts) + '\n';
        html += 'スロット数: ' + r.diag.slotCount + '\n';
        if (r.diag.slotSample) {
          html += 'スロット例: startMin=' + r.diag.slotSample.startMin +
            ', endMin=' + r.diag.slotSample.endMin +
            ', row=' + r.diag.slotSample.row + '\n';
        }
        if (r.diag.staffSample) {
          html += 'スタッフ例: ' + r.diag.staffSample.name +
            ' (shift ' + r.diag.staffSample.shiftStart +
            '-' + r.diag.staffSample.shiftEnd + ')\n';
        }
        html += 'スキル持ち場: ' + JSON.stringify(r.diag.skillPostNames) + '\n';
        html += 'スキルLv例: ' + JSON.stringify(r.diag.sampleSkillLevels);
        html += '</div>';
      }
    }
    area.innerHTML = html;
  }
</script>

</body>
</html>
