<!DOCTYPE html>
<html>
<head>
<base target="_top">
<style>
  * { box-sizing: border-box; margin: 0; padding: 0; }
  body {
    font-family: 'Segoe UI', 'Meiryo', sans-serif;
    font-size: 14px;
    color: #333;
    background: #fff;
    padding: 20px;
  }
  .step-indicator {
    text-align: center;
    color: #666;
    font-size: 13px;
    margin-bottom: 16px;
  }
  .step-title {
    font-size: 16px;
    font-weight: bold;
    margin-bottom: 16px;
  }
  .step { display: none; }
  .step.active { display: block; }

  /* 部署選択 */
  .dept-list { list-style: none; }
  .dept-list li {
    padding: 10px 12px;
    border: 1px solid #ddd;
    border-radius: 4px;
    margin-bottom: 8px;
    cursor: pointer;
    transition: background 0.15s;
  }
  .dept-list li:hover { background: #f0f4ff; }
  .dept-list li.selected {
    background: #e3edff;
    border-color: #4285f4;
  }
  .dept-list li label {
    cursor: pointer;
    display: block;
  }
  .dept-list li input[type="radio"] { margin-right: 8px; }

  /* 日付選択 */
  .date-list { list-style: none; max-height: 280px; overflow-y: auto; }
  .date-list li {
    padding: 8px 12px;
    border: 1px solid #ddd;
    border-radius: 4px;
    margin-bottom: 6px;
    cursor: pointer;
    transition: background 0.15s;
  }
  .date-list li:hover { background: #f0f4ff; }
  .date-list li.selected {
    background: #e3edff;
    border-color: #4285f4;
  }
  .date-list li label { cursor: pointer; display: block; }
  .date-list li input[type="checkbox"] { margin-right: 8px; }
  .staff-count { color: #888; font-size: 13px; margin-left: 8px; }
  .select-actions { margin-bottom: 8px; }
  .select-actions a {
    color: #4285f4;
    cursor: pointer;
    font-size: 13px;
    margin-right: 12px;
    text-decoration: none;
  }
  .select-actions a:hover { text-decoration: underline; }

  /* 確認画面 */
  .confirm-section { margin-bottom: 12px; }
  .confirm-label { font-weight: bold; color: #555; font-size: 13px; }
  .confirm-value { margin-top: 4px; }

  /* 結果表示 */
  .result-item {
    padding: 6px 0;
    border-bottom: 1px solid #eee;
    font-size: 13px;
  }
  .result-success { color: #0d7d2c; }
  .result-summary {
    font-size: 15px;
    font-weight: bold;
    margin-bottom: 12px;
    color: #0d7d2c;
  }

  /* ボタン */
  .btn-row {
    margin-top: 20px;
    display: flex;
    justify-content: space-between;
  }
  .btn {
    padding: 8px 24px;
    border: none;
    border-radius: 4px;
    font-size: 14px;
    cursor: pointer;
    transition: background 0.15s;
  }
  .btn:disabled { opacity: 0.5; cursor: not-allowed; }
  .btn-primary { background: #4285f4; color: #fff; }
  .btn-primary:hover:not(:disabled) { background: #3367d6; }
  .btn-secondary { background: #f1f3f4; color: #333; }
  .btn-secondary:hover:not(:disabled) { background: #e0e0e0; }
  .btn-danger { background: #ea4335; color: #fff; }
  .btn-danger:hover:not(:disabled) { background: #c5221f; }

  /* スピナー */
  .spinner-area {
    text-align: center;
    padding: 30px 0;
    display: none;
  }
  .spinner-area.visible { display: block; }
  .spinner {
    display: inline-block;
    width: 32px;
    height: 32px;
    border: 3px solid #e0e0e0;
    border-top-color: #4285f4;
    border-radius: 50%;
    animation: spin 0.8s linear infinite;
  }
  @keyframes spin { to { transform: rotate(360deg); } }
  .spinner-text { margin-top: 10px; color: #666; }

  /* エラー */
  .error-msg {
    background: #fce8e6;
    color: #c5221f;
    padding: 10px 12px;
    border-radius: 4px;
    margin-top: 12px;
    display: none;
    font-size: 13px;
  }
  .error-msg.visible { display: block; }

  /* ローディング初期 */
  .loading-area {
    text-align: center;
    padding: 40px 0;
    color: #666;
  }
</style>
</head>
<body>

<div id="loadingArea" class="loading-area">
  <div class="spinner" style="margin: 0 auto;"></div>
  <div class="spinner-text">読み込み中...</div>
</div>

<div id="wizardContent" style="display:none;">
  <div class="step-indicator" id="stepIndicator"></div>

  <!-- Step 0: 部署選択 -->
  <div class="step active" id="step0">
    <div class="step-title">部署を選択してください</div>
    <ul class="dept-list" id="deptList"></ul>
    <div class="btn-row">
      <span></span>
      <button class="btn btn-primary" id="btnStep0Next" disabled onclick="goToStep(1)">次へ</button>
    </div>
  </div>

  <!-- Step 1: 日付選択 -->
  <div class="step" id="step1">
    <div class="step-title">日付を選択してください（複数選択可）</div>
    <div class="select-actions">
      <a onclick="selectAllDates()">すべて選択</a>
      <a onclick="deselectAllDates()">すべて解除</a>
    </div>
    <ul class="date-list" id="dateList"></ul>
    <div id="dateSpinner" class="spinner-area">
      <div class="spinner" style="margin: 0 auto;"></div>
      <div class="spinner-text">日付を読み込み中...</div>
    </div>
    <div class="btn-row">
      <button class="btn btn-secondary" onclick="goToStep(0)">戻る</button>
      <button class="btn btn-primary" id="btnStep1Next" disabled onclick="goToStep(2)">次へ</button>
    </div>
  </div>

  <!-- Step 2: 確認＆生成 -->
  <div class="step" id="step2">
    <div class="step-title">確認</div>
    <div id="confirmArea">
      <div class="confirm-section">
        <div class="confirm-label">部署</div>
        <div class="confirm-value" id="confirmDept"></div>
      </div>
      <div class="confirm-section">
        <div class="confirm-label">日付</div>
        <div class="confirm-value" id="confirmDates"></div>
      </div>
      <div class="confirm-section">
        <div class="confirm-label">除外</div>
        <div class="confirm-value" style="color:#888;">なし（7A-2で追加予定）</div>
      </div>
    </div>
    <div id="generateSpinner" class="spinner-area">
      <div class="spinner" style="margin: 0 auto;"></div>
      <div class="spinner-text">生成しています...</div>
    </div>
    <div id="resultArea" style="display:none;">
    </div>
    <div id="errorArea" class="error-msg"></div>
    <div class="btn-row" id="confirmButtons">
      <button class="btn btn-secondary" id="btnStep2Back" onclick="goToStep(1)">戻る</button>
      <button class="btn btn-primary" id="btnGenerate" onclick="onGenerate()">生成する</button>
    </div>
    <div class="btn-row" id="closeButtons" style="display:none;">
      <span></span>
      <button class="btn btn-primary" onclick="google.script.host.close()">閉じる</button>
    </div>
  </div>
</div>

<script>
  var state = {
    departments: [],
    selectedDept: null,
    dates: [],
    selectedDates: []
  };

  // 初期化: 部署一覧取得
  google.script.run
    .withSuccessHandler(function(depts) {
      state.departments = depts;
      renderDeptList();
      document.getElementById('loadingArea').style.display = 'none';
      document.getElementById('wizardContent').style.display = 'block';
      updateStepIndicator(0);
    })
    .withFailureHandler(function(err) {
      document.getElementById('loadingArea').innerHTML =
        '<div style="color:#c5221f;">部署一覧の取得に失敗しました: ' + err.message + '</div>';
    })
    .uiWizard_loadDepartments();

  function updateStepIndicator(step) {
    document.getElementById('stepIndicator').textContent =
      'ステップ ' + (step + 1) + '/3';
  }

  function renderDeptList() {
    var ul = document.getElementById('deptList');
    ul.innerHTML = '';
    for (var i = 0; i < state.departments.length; i++) {
      var dept = state.departments[i];
      var li = document.createElement('li');
      li.setAttribute('data-name', dept.name);
      var label = document.createElement('label');
      var radio = document.createElement('input');
      radio.type = 'radio';
      radio.name = 'dept';
      radio.value = dept.name;
      radio.onchange = (function(name, el) {
        return function() { selectDept(name, el); };
      })(dept.name, li);
      label.appendChild(radio);
      label.appendChild(document.createTextNode(dept.name));
      li.appendChild(label);
      ul.appendChild(li);
    }
  }

  function selectDept(name, liEl) {
    state.selectedDept = name;
    var items = document.querySelectorAll('.dept-list li');
    for (var i = 0; i < items.length; i++) {
      items[i].classList.remove('selected');
    }
    liEl.classList.add('selected');
    document.getElementById('btnStep0Next').disabled = false;
  }

  function goToStep(step) {
    // 非表示にする
    var steps = document.querySelectorAll('.step');
    for (var i = 0; i < steps.length; i++) {
      steps[i].classList.remove('active');
    }
    document.getElementById('step' + step).classList.add('active');
    updateStepIndicator(step);

    if (step === 1) {
      loadDates();
    } else if (step === 2) {
      renderConfirm();
    }
  }

  function loadDates() {
    var dateList = document.getElementById('dateList');
    dateList.innerHTML = '';
    document.getElementById('dateSpinner').classList.add('visible');
    document.getElementById('btnStep1Next').disabled = true;

    google.script.run
      .withSuccessHandler(function(dates) {
        state.dates = dates;
        state.selectedDates = [];
        document.getElementById('dateSpinner').classList.remove('visible');
        renderDateList();
      })
      .withFailureHandler(function(err) {
        document.getElementById('dateSpinner').classList.remove('visible');
        dateList.innerHTML =
          '<li style="color:#c5221f;">日付の取得に失敗しました: ' + err.message + '</li>';
      })
      .uiWizard_loadDates(state.selectedDept);
  }

  function renderDateList() {
    var ul = document.getElementById('dateList');
    ul.innerHTML = '';
    for (var i = 0; i < state.dates.length; i++) {
      var d = state.dates[i];
      var li = document.createElement('li');
      li.setAttribute('data-value', d.dateValue);
      var label = document.createElement('label');
      var cb = document.createElement('input');
      cb.type = 'checkbox';
      cb.value = d.dateValue;
      cb.onchange = (function(val, el) {
        return function() { toggleDate(val, el, this.checked); };
      })(d.dateValue, li);
      label.appendChild(cb);
      label.appendChild(document.createTextNode(
        d.dateStr + ' (' + d.dayOfWeek + ')'));
      var span = document.createElement('span');
      span.className = 'staff-count';
      span.textContent = '出勤: ' + d.staffCount + '名';
      label.appendChild(span);
      li.appendChild(label);
      ul.appendChild(li);
    }
  }

  function toggleDate(val, liEl, checked) {
    if (checked) {
      if (state.selectedDates.indexOf(val) === -1) {
        state.selectedDates.push(val);
      }
      liEl.classList.add('selected');
    } else {
      var idx = state.selectedDates.indexOf(val);
      if (idx >= 0) state.selectedDates.splice(idx, 1);
      liEl.classList.remove('selected');
    }
    document.getElementById('btnStep1Next').disabled = state.selectedDates.length === 0;
  }

  function selectAllDates() {
    state.selectedDates = [];
    var items = document.querySelectorAll('.date-list li');
    for (var i = 0; i < items.length; i++) {
      items[i].classList.add('selected');
      var cb = items[i].querySelector('input[type="checkbox"]');
      cb.checked = true;
      state.selectedDates.push(cb.value);
    }
    document.getElementById('btnStep1Next').disabled = state.selectedDates.length === 0;
  }

  function deselectAllDates() {
    state.selectedDates = [];
    var items = document.querySelectorAll('.date-list li');
    for (var i = 0; i < items.length; i++) {
      items[i].classList.remove('selected');
      items[i].querySelector('input[type="checkbox"]').checked = false;
    }
    document.getElementById('btnStep1Next').disabled = true;
  }

  function renderConfirm() {
    document.getElementById('confirmDept').textContent = state.selectedDept;

    // 選択日付の表示テキスト構築
    var dateTexts = [];
    for (var i = 0; i < state.selectedDates.length; i++) {
      var val = state.selectedDates[i];
      for (var j = 0; j < state.dates.length; j++) {
        if (state.dates[j].dateValue === val) {
          dateTexts.push(state.dates[j].dateStr + '(' + state.dates[j].dayOfWeek + ')');
          break;
        }
      }
    }
    document.getElementById('confirmDates').textContent =
      dateTexts.join(', ') + ' (' + dateTexts.length + '件)';

    // UIリセット
    document.getElementById('confirmArea').style.display = 'block';
    document.getElementById('generateSpinner').classList.remove('visible');
    document.getElementById('resultArea').style.display = 'none';
    document.getElementById('errorArea').classList.remove('visible');
    document.getElementById('confirmButtons').style.display = 'flex';
    document.getElementById('closeButtons').style.display = 'none';
  }

  function onGenerate() {
    // ボタン無効化＋スピナー表示
    document.getElementById('btnGenerate').disabled = true;
    document.getElementById('btnStep2Back').disabled = true;
    document.getElementById('generateSpinner').classList.add('visible');
    document.getElementById('errorArea').classList.remove('visible');

    var params = {
      departmentName: state.selectedDept,
      dateValues: state.selectedDates
    };

    google.script.run
      .withSuccessHandler(function(result) {
        document.getElementById('generateSpinner').classList.remove('visible');
        showResult(result);
      })
      .withFailureHandler(function(err) {
        document.getElementById('generateSpinner').classList.remove('visible');
        document.getElementById('btnGenerate').disabled = false;
        document.getElementById('btnStep2Back').disabled = false;
        var errorArea = document.getElementById('errorArea');
        errorArea.textContent = '生成に失敗しました: ' + err.message;
        errorArea.classList.add('visible');
      })
      .uiWizard_generate(params);
  }

  function showResult(result) {
    document.getElementById('confirmButtons').style.display = 'none';
    document.getElementById('closeButtons').style.display = 'flex';

    var area = document.getElementById('resultArea');
    area.style.display = 'block';

    var html = '<div class="result-summary">' +
      result.results.length + '件の配置を生成しました</div>';
    for (var i = 0; i < result.results.length; i++) {
      var r = result.results[i];
      html += '<div class="result-item">' +
        r.dateSheet + ': ' + r.placementCount + '配置 / ' +
        r.staffCount + '名</div>';
      if (r.diag) {
        html += '<div style="background:#fff3e0;padding:10px;margin:8px 0;border-radius:4px;font-size:12px;white-space:pre-wrap;">';
        html += '<b>診断情報（0配置）</b>\n';
        html += 'プリセット数: ' + r.diag.presetCount + '\n';
        html += 'プリセット持ち場: ' + JSON.stringify(r.diag.presetPosts) + '\n';
        html += 'スロット数: ' + r.diag.slotCount + '\n';
        if (r.diag.slotSample) {
          html += 'スロット例: startMin=' + r.diag.slotSample.startMin +
            ', endMin=' + r.diag.slotSample.endMin +
            ', row=' + r.diag.slotSample.row + '\n';
        }
        if (r.diag.staffSample) {
          html += 'スタッフ例: ' + r.diag.staffSample.name +
            ' (shift ' + r.diag.staffSample.shiftStart +
            '-' + r.diag.staffSample.shiftEnd + ')\n';
        }
        html += 'スキル持ち場: ' + JSON.stringify(r.diag.skillPostNames) + '\n';
        html += 'スキルLv例: ' + JSON.stringify(r.diag.sampleSkillLevels);
        html += '</div>';
      }
    }
    area.innerHTML = html;
  }
</script>

</body>
</html>
